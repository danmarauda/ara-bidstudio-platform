# GitLab CI/CD Testing Pipeline Setup

This document describes the automated testing pipeline integrated with GitLab CI for NodeBench AI.

## Overview

The pipeline provides comprehensive test coverage with the following stages:

1. **Validate** - Type checking, linting, and Convex validation
2. **Test** - Unit, integration, Convex, and E2E tests
3. **Coverage** - Coverage collection and threshold checking
4. **Report** - Test summary generation

## Pipeline Stages

### 1. Validation Stage

- **lint:typescript** - TypeScript type checking for both frontend and Convex
- **lint:eslint** - ESLint code quality checks
- **lint:convex** - Convex schema and function validation

### 2. Test Stage

- **test:unit** - Unit tests with coverage
- **test:integration** - Integration tests with coverage
- **test:convex** - Convex backend tests (runs on MRs and main branches)
- **test:e2e** - End-to-end tests (runs on MRs and main branches, allowed to fail)
- **test:all** - Combined test run for merge requests

### 3. Coverage Stage

- **coverage:collect** - Merges coverage reports from all test jobs
- **coverage:check** - Validates coverage meets threshold (default: 70%)

### 4. Report Stage

- **report:test-results** - Generates comprehensive test summary

## Configuration

### Environment Variables

Set these in GitLab CI/CD Settings → Variables:

#### Required
- `CONVEX_URL` - Your Convex deployment URL
- `OPENAI_API_KEY` - OpenAI API key for AI tests

#### Optional
- `CONVEX_DEPLOYMENT_URL` - Specific Convex deployment for E2E tests
- `COVERAGE_THRESHOLD` - Coverage threshold percentage (default: 70)

### Coverage Thresholds

Default thresholds (configurable via `COVERAGE_THRESHOLD`):
- Lines: 70%
- Statements: 70%
- Functions: 70%
- Branches: 70%

## Test Reports

### JUnit XML Reports

Test results are published as JUnit XML for GitLab integration:
- `reports/junit.xml` - Unit tests
- `reports/junit-integration.xml` - Integration tests
- `reports/junit-convex.xml` - Convex tests
- `reports/junit-e2e.xml` - E2E tests

### Coverage Reports

Coverage is generated in multiple formats:
- **HTML**: `coverage/lcov-report/index.html` - Human-readable report
- **LCOV**: `coverage/lcov.info` - Standard LCOV format
- **Cobertura**: `coverage/cobertura-coverage.xml` - GitLab integration
- **JSON**: `coverage/coverage-summary.json` - Programmatic access

### Test Summary

A markdown summary is generated at:
- `reports/test-summary.md`

## Viewing Results in GitLab

### Test Results

1. Navigate to **CI/CD → Pipelines**
2. Click on a pipeline
3. View test results in the **Tests** tab
4. See coverage visualization in the **Coverage** section

### Coverage Visualization

Coverage is automatically displayed in:
- Merge Request widgets
- Pipeline details page
- Coverage reports section

### Artifacts

Download test artifacts from:
- Pipeline → Job → Artifacts
- Available artifacts:
  - Coverage reports (HTML, LCOV, Cobertura)
  - Test summary markdown
  - Screenshots (from E2E tests)

## Local Testing

Run the same tests locally:

```bash
# Run all tests with coverage
npm run test:all:ci

# Run specific test suites
npm run test:unit:ci
npm run test:integration:ci
npm run test:convex:ci
npm run test:e2e:ci

# Check coverage thresholds
npm run coverage:check

# Generate test summary
npm run report:test-summary
```

## Caching

The pipeline uses intelligent caching:
- **Node modules** - Cached based on `package-lock.json`
- **Convex cache** - Cached for faster builds

Cache is automatically invalidated when dependencies change.

## Job Execution Rules

### Always Run
- `lint:typescript`
- `lint:eslint`
- `lint:convex`
- `test:unit`
- `test:integration`
- `coverage:collect`
- `coverage:check`

### Run on MRs and Main Branches
- `test:convex`
- `test:e2e`
- `test:all`

### Allowed to Fail
- `test:e2e` - E2E tests may be flaky
- `report:test-results` - Reporting is non-critical

## Troubleshooting

### Tests Failing

1. **Check job logs** - View detailed error messages
2. **Run locally** - Reproduce issues with `npm run test:all:ci`
3. **Check environment variables** - Ensure all required vars are set
4. **Review coverage** - Check if coverage threshold is too high

### Coverage Not Showing

1. **Check coverage artifacts** - Ensure `coverage:collect` job succeeded
2. **Verify Cobertura format** - Check `coverage/cobertura-coverage.xml` exists
3. **Check GitLab settings** - Coverage visualization must be enabled

### Convex Tests Failing

1. **Verify CONVEX_URL** - Must point to valid Convex deployment
2. **Check API keys** - OPENAI_API_KEY required for AI tests
3. **Review Convex logs** - Check Convex dashboard for errors

## Best Practices

1. **Keep tests fast** - Unit tests should complete in < 1 minute
2. **Isolate tests** - Each test should be independent
3. **Mock external services** - Use mocks for API calls in unit tests
4. **Use E2E sparingly** - Reserve E2E for critical user flows
5. **Maintain coverage** - Aim for > 80% coverage on new code

## Pipeline Performance

Expected job durations:
- Validation: ~2-3 minutes
- Unit tests: ~3-5 minutes
- Integration tests: ~5-8 minutes
- Convex tests: ~5-10 minutes
- E2E tests: ~10-20 minutes
- Coverage: ~1-2 minutes

Total pipeline time: ~20-40 minutes (depending on parallelization)

## Advanced Configuration

### Custom Coverage Thresholds

Set per-project thresholds in `vitest.config.ts`:

```typescript
coverage: {
  thresholds: {
    lines: 80,
    functions: 80,
    branches: 75,
    statements: 80,
  },
}
```

### Parallel Test Execution

Tests run in parallel by default. To control parallelism:

```yaml
test:unit:
  parallel:
    matrix:
      - TEST_SUITE: [unit, integration]
```

### Conditional Execution

Modify `.gitlab-ci.yml` to add conditions:

```yaml
test:e2e:
  only:
    changes:
      - src/**/*.tsx
      - src/**/*.ts
```

## Support

For issues or questions:
1. Check pipeline logs
2. Review test output
3. Consult project documentation
4. Contact the development team

